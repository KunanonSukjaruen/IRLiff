<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Member Registration</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <center>
    <h1>Member Registration</h1>
    <div id="registrationForm" style="display:none;">
      <input type="text" id="empNo" placeholder="Employee Number">
      <input type="text" id="name" placeholder="Name">
      <button onclick="register()">Register</button>
    </div>
    <div id="userInfo" style="display:none;">
      <p>Employee Number: <span id="displayEmpNo"></span></p>
      <p>Name: <span id="displayName"></span></p>
    </div>
  </center>

  <script>
    let uid;

    function initializeLiff(myLiffId) {
      liff.init({ liffId: myLiffId }).then(() => {
        if (liff.isLoggedIn()) {
          liff.getProfile().then(profile => {
            uid = profile.userId;
            checkUser(uid);
          }).catch(err => console.error('Failed to get user profile:', err));
        } else {
          liff.login();
        }
      }).catch(err => console.error('LIFF Initialization failed:', err));
    }

    function checkUser(uid) {
      google.script.run.withSuccessHandler(function(response) {
        if (response.found) {
          document.getElementById('displayEmpNo').textContent = response.empNo;
          document.getElementById('displayName').textContent = response.name;
          document.getElementById('userInfo').style.display = 'block';
        } else {
          document.getElementById('registrationForm').style.display = 'block';
        }
      }).checkUser(uid);
    }

    function register() {
      const empNo = document.getElementById('empNo').value;
      const name = document.getElementById('name').value;
      google.script.run.withSuccessHandler(function(response) {
        if (response.success) {
          window.alert('Registration successful');
          liff.closeWindow();
        }
      }).registerUser(uid, empNo, name);
    }

    window.onload = function() {
      initializeLiff('1606478942-pB2qaWE1');
    };
  </script>
</body>
</html>
