<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>LIFF App 18:12</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <!-- Section to display user information or registration form -->
    <div id="userContent">
        <!-- User Redemption Page -->
        <div id="redeemSection" style="display:none;">
            <h2>Redeem Page</h2>
            <p><strong>Employee Number:</strong> <span id="empNo"></span></p>
            <p><strong>Name:</strong> <span id="name"></span></p>
            <p><strong>Division:</strong> <span id="division"></span></p>
            <p><strong>Factory:</strong> <span id="factory"></span></p>
            <p><strong>Points:</strong> <span id="points"></span></p>
            <input type="text" id="redeemCodeInput" placeholder="Enter Redeem Code">
            <button onclick="checkRedeemCode()">Redeem</button>
        </div>

        <!-- User Registration Page -->
        <div id="registerSection" style="display:none;">
            <h2>Register Page</h2>
            <input type="text" id="empNoInput" placeholder="Enter Employee Number">
            <input type="date" id="empDateInput" placeholder="Enter Employment Date">
            <button onclick="registerUser()">Check and Register</button>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertMessage"></div>

    <script>
        // Initialize LIFF app
function initializeLiff() {
    liff.init({ liffId: '1606478942-pB2qaWE1' }).then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const uid = liff.getContext().userId;
            getUserData(uid); // ทำการดึงข้อมูลผู้ใช้ต่อไป
        }
    }).catch(err => {
        console.error('LIFF initialization failed', err);
    });
}


        // Function to fetch user data based on UID from LIFF
        function getUserData() {
            const uid = liff.getContext().userId;
            fetch('https://script.google.com/macros/s/AKfycbxeJrkSUAdLvAFTnjnXL1VSbW2p0MI_uFXZ9WlizbV5MzB5N0STarj7g2L_qDP5rCf6/exec?action=getUserData&uid=' + uid)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        displayRegisterSection();
                    } else {
                        displayRedeemSection(data.data);
                    }
                });
        }

        // Display Redeem Section with fetched data
        function displayRedeemSection(userData) {
            document.getElementById('redeemSection').style.display = 'block';
            document.getElementById('empNo').textContent = userData[0];
            document.getElementById('name').textContent = userData[2];
            document.getElementById('division').textContent = userData[3];
            document.getElementById('factory').textContent = userData[4];
            document.getElementById('points').textContent = userData[6];
        }

        // Function to check redeem code
        function checkRedeemCode() {
            const empNo = document.getElementById('empNo').textContent;
            const code = document.getElementById('redeemCodeInput').value;
            fetch('https://script.google.com/macros/s/AKfycbxeJrkSUAdLvAFTnjnXL1VSbW2p0MI_uFXZ9WlizbV5MzB5N0STarj7g2L_qDP5rCf6/exec?action=redeemCode&empNo=' + empNo + '&code=' + code)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('alertMessage').textContent = data.message;
                    if (data.success) {
                        // Optionally refresh data or inform user of success
                    }
                });
        }

        // Display Registration Section
        function displayRegisterSection() {
            document.getElementById('registerSection').style.display = 'block';
        }

        // Function to handle user registration
        function registerUser() {
            const empNo = document.getElementById('empNoInput').value;
            const empDate = document.getElementById('empDateInput').value;
            const uid = liff.getContext().userId; // Get UID from LIFF context
            fetch('https://script.google.com/macros/s/AKfycbxeJrkSUAdLvAFTnjnXL1VSbW2p0MI_uFXZ9WlizbV5MzB5N0STarj7g2L_qDP5rCf6/exec?action=registerUser&empNo=' + empNo + '&empDate=' + empDate + '&uid=' + uid)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('alertMessage').textContent = data.message;
                    if (data.success) {
                displayRedeemSectionAfterRegistration(empNo, uid);
            }
        });
}

// Function to display redeem section after successful registration
function displayRedeemSectionAfterRegistration(empNo, uid) {
    // Fetch user data to fill the redeem section
    fetch('https://script.google.com/macros/s/AKfycbxeJrkSUAdLvAFTnjnXL1VSbW2p0MI_uFXZ9WlizbV5MzB5N0STarj7g2L_qDP5rCf6/exec?action=getUserData&uid=' + uid)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRedeemSection(data.data);  // Assuming this function already sets the appropriate fields
                document.getElementById('redeemSection').style.display = 'block';
                document.getElementById('registerSection').style.display = 'none';
                document.getElementById('alertMessage').textContent = 'Registration successful! Proceed to redeem your points.';
            } else {
                document.getElementById('alertMessage').textContent = 'Error fetching user data for redeem section.';
            }
        });
}

        // Call initialize function on load
        window.onload = initializeLiff;
    </script>
</body>
</html>
